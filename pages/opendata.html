<!DOCTYPE html>

<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Wan - OpenData</title>
  <LINK href="../index.css" rel="stylesheet" type="text/css"/>
  <link rel="icon" type="image/x-icon" href="/images/favicon_wan.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">  <script href="../index.js" type="text/css"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="../index.html">
        <img src="../images/Wan.png" alt="" width="100rem"class="d-inline-block align-text-top">
      </a>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="../index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled">More</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <br>
  <h1 style="text-align: center; margin-top: 0.5rem;">Estrazione dati Open data</h1>
  <div style="text-align: center; padding-top: 0.5rem; width: 100%; margin: 0 auto;" id="filters">
    <br>
    <div class="input-group mb-3" style="width: 30%;margin: 0 auto;">
      <input id="search-input-ente" type="text" class="form-control" placeholder="Cerca per ente">
      <button class="btn btn-primary" id="search-button-ente" type="button">
        <i class="bi bi-search"></i>
      </button>
    </div>
    <div class="input-group mb-3" style="width: 30%;margin: 0 auto;">
      <input id="search-input-comune" type="text" class="form-control" placeholder="Cerca per comune">
      <button class="btn btn-primary" id="search-button-comune" type="button">
        <i class="bi bi-search"></i>
      </button>
    </div>
    <div class="input-group mb-3" style="width: 30%;margin: 0 auto;">
      <input id="search-input-provincia" type="text" class="form-control" placeholder="Cerca per provincia">
      <button class="btn btn-primary" id="search-button-provincia" type="button">
        <i class="bi bi-search"></i>
      </button>
    </div>
    <div style="padding: 10px; margin: 0 auto;" id="filterContainer">
      <button class="btn btn-primary" onclick="location.reload()"><span class="glyphicon glyphicon-refresh"></span> Cancella filtri</button>
      <button class="btn btn-danger" id="btnImporto"><span class="glyphicon glyphicon-refresh"></span> Calcola importo</button>    
    </div>
    <div id="labelsImporto" style="display: none; width: 30%;margin: 0 auto;">
      <span class="text">Somma importo finanziamento: </span><span id="sumImporto" class="sum">0</span><br>
      <span class="text">Somma spesa presunta: </span><span id="sumSpesaPres" class="sum">0</span><br>
      <span class="text">Somma residuo: </span><span id="sumResiduo" class="sum">0</span>
      <br><br>
    </div>
    <div id="labelsEntrate" style="display: none; width: 30%;margin: 0 auto;">
      <span class="text"><b>Entrate correnti</b>: </span><span id="entrCorrenti" class="entr">0</span><br>
      <span class="text"><b>Entrate capitali</b>: </span><span id="entrCapitali" class="entr">0</span><br>
      <br><br>
    </div>
  </div>
  <br>
  <div class="main-wrapper">
    <div id="tableContainer" style="visibility: visible;" class="responsive-table">
      <table id="table" class="table">
        <thead id="tableHead" style="overflow: hidden;text-align: center;">
          <tr>
            <th scope="col">Ente</th>
            <th scope="col">Comune</th>
            <th scope="col">Provincia</th>
            <th scope="col">Regione</th>
            <th scope="col">Importo finanziamento</th>
            <th scope="col">Avviso</th>
            <th scope="col">Data finanziamento</th>
            <th scope="col">Stato candidatura</th>
            <th scope="col">Percentuale</th>
            <th scope="col">Spesa presunta</th>
            <th scope="col">Residuo</th>
          </tr>
        </thead>
        <tbody id="tableBody" style="text-align: center; vertical-align: middle;">

        </tbody>
      </table>
    </div>
    <div id="tableContainerImporto" style="visibility:hidden;" class="responsive-table">
      <table id="tableImporto" class="table">
        <thead id="tableHeadImporto" style="overflow: hidden;">
          <tr>
            <th scope="col">Ente</th>
            <th scope="col">Avviso</th>
            <th scope="col">Residuo</th>
            <th scope="col">Importo finanziamento</th>
          </tr>
        </thead>
        <tbody id="tableBodyImporto">

        </tbody>
      </table>
    </div>
  </div>
  <br><br><br><br>
  <footer id="sticky-footer" class="flex-shrink-0 py-4 bg-dark text-white-50">
    <div class="container text-center">
      <small>Copyright &copy; Wan S.r.l.</small>
    </div>
  </footer>
  
  
  
  <script>
    let isFiltered = false
    let lastIndex = 0
    $.getJSON('https://raw.githubusercontent.com/teamdigitale/padigitale2026-opendata/main/data/candidature_comuni_finanziate.json', function(data) {
      isFiltered = false  
      for(let i = 0; i < 300; i++)
        {
          let newRow = $("<tr>")
          $("<td>").html(data[i].ente).appendTo(newRow)
          $("<td>").html(data[i].comune).appendTo(newRow)
          $("<td>").html(data[i].provincia).appendTo(newRow)
          $("<td>").html(data[i].regione).appendTo(newRow)
          $("<td>").html(data[i].importo_finanziamento.toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
          $("<td>").html(data[i].avviso).appendTo(newRow)
          $("<td>").html(data[i].data_finanziamento).appendTo(newRow)
          $("<td>").html(data[i].stato_candidatura).appendTo(newRow)
            if(data[i].avviso.includes("1.2")){
              $("<td>").html("15%").appendTo(newRow);
              $("<td>").html(((data[i].importo_finanziamento * 15)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 15)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.1")){
              $("<td>").html("20%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 20)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 20)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.3 - app IO")){
              $("<td>").html("40%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 40)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 40)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.3 - pagoPA")){
              $("<td>").html("35%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 35)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 35)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.4")){
              $("<td>").html("20%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 20)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 20)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.5")){
              $("<td>").html("60%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 60)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 60)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else {
              $("<td>").html("").appendTo(newRow)
            }
          
          newRow.appendTo("#table tbody")
        }
        lastIndex = 300
    });

    function myFunction() {
    // Declare variables
    var inputEnte, inputComune, inputProvincia, filterEnte, filterComune, filterProvincia, table, tr, tdEnte, tdComune, tdProvincia, i, txtValueEnte, txtValueComune, txtValueProvincia
    inputEnte = document.getElementById("filterEnte");
    inputComune = document.getElementById("filterComune");
    inputProvincia = document.getElementById("filterProvincia");
    filterEnte = inputEnte.value.toUpperCase();
    filterComune = inputComune.value.toUpperCase();
    filterProvincia = inputProvincia.value.toUpperCase();
    table = document.getElementById("table");
    tr = table.getElementsByTagName("tr");

    // Loop through all table rows, and hide those who don't match the search query
    for (i = 0; i < tr.length; i++) {
      tdEnte = tr[i].getElementsByTagName("td")[1];
      tdComune = tr[i].getElementsByTagName("td")[2];
      tdProvincia = tr[i].getElementsByTagName("td")[3];
      if (td) {
        txtValue = td.textContent || td.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  }

  document.getElementsByClassName("main-wrapper")[0].addEventListener("scroll", function() {
    
    if(isFiltered == false) {
      var scrollTop = document.getElementsByClassName("main-wrapper")[0].scrollTop;
      var scrollHeight = document.getElementsByClassName("main-wrapper")[0].scrollHeight;
      var offsetHeight = document.getElementsByClassName("main-wrapper")[0].offsetHeight;

      //check if the scroll reached the bottom
      if (offsetHeight + scrollTop >= scrollHeight)
      {
        $.getJSON('https://raw.githubusercontent.com/teamdigitale/padigitale2026-opendata/main/data/candidature_comuni_finanziate.json', function(data) {
          for(let i = lastIndex; i < (lastIndex + 300); i++)
          {
            let newRow = $("<tr>")
            $("<td>").html(data[i].ente).appendTo(newRow)
            $("<td>").html(data[i].comune).appendTo(newRow)
            $("<td>").html(data[i].provincia).appendTo(newRow)
            $("<td>").html(data[i].regione).appendTo(newRow)
            $("<td>").html(data[i].importo_finanziamento.toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            $("<td>").html(data[i].avviso).appendTo(newRow)
            $("<td>").html(data[i].data_finanziamento).appendTo(newRow)
            $("<td>").html(data[i].stato_candidatura).appendTo(newRow)
            if(data[i].avviso.includes("1.2")){
              $("<td>").html("15%").appendTo(newRow);
              $("<td>").html(((data[i].importo_finanziamento * 15)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 15)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.1")){
              $("<td>").html("20%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 20)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 20)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.3 - app IO")){
              $("<td>").html("40%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 40)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 40)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.3 - pagoPA")){
              $("<td>").html("35%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 35)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 35)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.4")){
              $("<td>").html("20%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 20)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 20)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(data[i].avviso.includes("1.4.5")){
              $("<td>").html("60%").appendTo(newRow)
              $("<td>").html(((data[i].importo_finanziamento * 60)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((data[i].importo_finanziamento - ((data[i].importo_finanziamento * 60)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else {
              $("<td>").html("").appendTo(newRow)
            }
          
          newRow.appendTo("#table tbody")
          }
          lastIndex += 300
      });
      }
    }
});

  $("#search-button-ente").on('click', () => {
      let inputValue = $("#search-input-ente").val();
      if(inputValue != "") {
        isFiltered = true
        let array = null
        $("#table tbody tr").each(function() {
          $(this).remove()
        })
        $.getJSON('https://raw.githubusercontent.com/teamdigitale/padigitale2026-opendata/main/data/candidature_comuni_finanziate.json', function(data) {
          array = data.filter(a => a.ente.toUpperCase() == ("COMUNE DI " & inputValue.toUpperCase()))
          let codComune = array[0].cod_comune
          for(let i = 0; i < array.length; i++)
          {
            let newRow = $("<tr>")
            $("<td>").html(array[i].ente).appendTo(newRow)
            $("<td>").html(array[i].comune).appendTo(newRow)
            $("<td>").html(array[i].provincia).appendTo(newRow)
            $("<td>").html(array[i].regione).appendTo(newRow)
            $("<td>").html(array[i].importo_finanziamento.toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            $("<td>").html(array[i].avviso).appendTo(newRow)
            $("<td>").html(array[i].data_finanziamento).appendTo(newRow)
            $("<td>").html(array[i].stato_candidatura).appendTo(newRow)
              if(array[i].cod_comune == codComune)
              {
                if(array[i].avviso.includes("1.2")){
                  $("<td>").html("15%").appendTo(newRow);
                  $("<td>").html(((array[i].importo_finanziamento * 15)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  $("<td>").html((array[i].importo_finanziamento - ((array[i].importo_finanziamento * 15)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                } else if(array[i].avviso.includes("1.4.1")){
                  $("<td>").html("20%").appendTo(newRow)
                  $("<td>").html(((array[i].importo_finanziamento * 20)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  $("<td>").html((array[i].importo_finanziamento - ((array[i].importo_finanziamento * 20)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                } else if(array[i].avviso.includes("1.4.3 - app IO")){
                  $("<td>").html("40%").appendTo(newRow)
                  $("<td>").html(((array[i].importo_finanziamento * 40)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  $("<td>").html((array[i].importo_finanziamento - ((array[i].importo_finanziamento * 40)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                } else if(array[i].avviso.includes("1.4.3 - pagoPA")){
                  $("<td>").html("35%").appendTo(newRow)
                  $("<td>").html(((array[i].importo_finanziamento * 35)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  $("<td>").html((array[i].importo_finanziamento - ((array[i].importo_finanziamento * 35)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                } else if(array[i].avviso.includes("1.4.4")){
                  $("<td>").html("20%").appendTo(newRow)
                  $("<td>").html(((array[i].importo_finanziamento * 20)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  $("<td>").html((array[i].importo_finanziamento - ((array[i].importo_finanziamento * 20)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                } else if(array[i].avviso.includes("1.4.5")){
                  $("<td>").html("60%").appendTo(newRow)
                  $("<td>").html(((array[i].importo_finanziamento * 60)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  $("<td>").html((array[i].importo_finanziamento - ((array[i].importo_finanziamento * 60)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                } else {
                  $("<td>").html("").appendTo(newRow)
                }
              }
            
          
          newRow.appendTo("#table tbody")
          }
        });
      } 
      else {
        alert("Inserire un valore!")
      }
  });
  $("#search-button-comune").on('click', () => {
      let inputValue = $("#search-input-comune").val();
      if(inputValue != "") {
        isFiltered = true
        let array = null
        $("#table tbody tr").each(function() {
          $(this).remove()
        })
        $.getJSON('https://raw.githubusercontent.com/teamdigitale/padigitale2026-opendata/main/data/candidature_comuni_finanziate.json', function(data) {
          array = data.filter(a => a.comune.toUpperCase().includes(inputValue.toUpperCase()))
          for(let i = 0; i < array.length; i++)
          {
            let newRow = $("<tr>")
            $("<td>").html(array[i].ente).appendTo(newRow)
            $("<td>").html(array[i].comune).appendTo(newRow)
            $("<td>").html(array[i].provincia).appendTo(newRow)
            $("<td>").html(array[i].regione).appendTo(newRow)
            $("<td>").html(array[i].importo_finanziamento.toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            $("<td>").html(array[i].avviso).appendTo(newRow)
            $("<td>").html(array[i].data_finanziamento).appendTo(newRow)
            $("<td>").html(array[i].stato_candidatura).appendTo(newRow)
            if(array[i].avviso.includes("1.2")){
              $("<td>").html("15%").appendTo(newRow);
              $("<td>").html((array[i].importo_finanziamento * 15)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 15)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.1")){
              $("<td>").html("20%").appendTo(newRow)
              $("<td>").html(((array[i].importo_finanziamento * 20)/100)).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 20)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.3 - app IO")){
              $("<td>").html("40%").appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento * 40)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 40)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.3 - pagoPA")){
              $("<td>").html("35%").appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento * 35)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 35)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.4")){
              $("<td>").html("20%").appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento * 20)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 20)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.5")){
              $("<td>").html("60%").appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento * 60)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 60)/100)).appendTo(newRow)
            } else {
              $("<td>").html("").appendTo(newRow)
            }
            newRow.appendTo("#table tbody")
          }
        });
      } 
      else {
        alert("Inserire un valore!")
      }
  });
  $("#search-button-provincia").on('click', () => {
      let inputValue = $("#search-input-provincia").val();
      if(inputValue != "") {
        isFiltered = true
        let array = null
        $("#table tbody tr").each(function() {
          $(this).remove()
        })
        $.getJSON('https://raw.githubusercontent.com/teamdigitale/padigitale2026-opendata/main/data/candidature_comuni_finanziate.json', function(data) {
          array = data.filter(a => a.provincia.toUpperCase().includes(inputValue.toUpperCase()))
          for(let i = 0; i < array.length; i++)
          {
            let newRow = $("<tr>")
            $("<td>").html(array[i].ente).appendTo(newRow)
            $("<td>").html(array[i].comune).appendTo(newRow)
            $("<td>").html(array[i].provincia).appendTo(newRow)
            $("<td>").html(array[i].regione).appendTo(newRow)
            $("<td>").html(array[i].importo_finanziamento.toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            $("<td>").html(array[i].avviso).appendTo(newRow)
            $("<td>").html(array[i].data_finanziamento).appendTo(newRow)
            $("<td>").html(array[i].stato_candidatura).appendTo(newRow)
            if(array[i].avviso.includes("1.2")){
              $("<td>").html("15%").appendTo(newRow);
              $("<td>").html(((array[i].importo_finanziamento * 15)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento - ((array[i].importo_finanziamento * 15)/100)).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.1")){
              $("<td>").html("20%").appendTo(newRow)
              $("<td>").html(((array[i].importo_finanziamento * 20)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 20)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.3 - app IO")){
              $("<td>").html("40%").appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento * 40)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 40)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.3 - pagoPA")){
              $("<td>").html("35%").appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento * 35)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 35)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.4")){
              $("<td>").html("20%").appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento * 20)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 20)/100)).appendTo(newRow)
            } else if(array[i].avviso.includes("1.4.5")){
              $("<td>").html("60%").appendTo(newRow)
              $("<td>").html((array[i].importo_finanziamento * 60)/100).appendTo(newRow)
              $("<td>").html(array[i].importo_finanziamento - ((array[i].importo_finanziamento * 60)/100)).appendTo(newRow)
            } else {
              $("<td>").html("").appendTo(newRow)
            }
            newRow.appendTo("#table tbody")
          }
        });
      } 
      else {
        alert("Inserire un valore!")
      }
  });

  $.fn.digits = function(){ 
    return this.each(function(){ 
        $(this).text( $(this).text().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1.") ); 
    })
}

  $("#btnImporto").on('click', () => {
      let inputValue = $("#search-input-ente").val();
      let sumSpesaPres = 0
      let sumResiduo = 0
      $("#tableContainer").css("visibility", "hidden")
      $("#tableContainerImporto").css("visibility", "visible")
      $("#labelsImporto").css("display", "block")
      $("#labelsEntrate").css("display", "block")

      if(inputValue != "") {
        isFiltered = true
        let array = null
        var items = {}, base, key;
        $("#table tr").each(function() {
          $(this).remove()
        })
        $("#tableImporto tbody tr").each(function() {
          $(this).remove()
        })
        $.getJSON('https://raw.githubusercontent.com/teamdigitale/padigitale2026-opendata/main/data/candidature_comuni_finanziate.json', function(data) {
          array = data.filter(a => a.ente.toUpperCase() == ("COMUNE DI " + inputValue.toUpperCase()))
          let codComune = array[0].cod_comune
          $.each(array, function(index, val) {
            let newRow = $("<tr>")
              if(val.cod_comune == codComune) {
                key = val.avviso;
                if (!items[key]) {
                    items[key] = 0;
                }
                items[key] += val.importo_finanziamento;
                if(val.avviso.includes("1.2")){
                  sumSpesaPres += (val.importo_finanziamento * 15)/100
                  sumResiduo += val.importo_finanziamento - ((val.importo_finanziamento * 15)/100)
                $("#sumSpesaPres").html(sumSpesaPres.toFixed(2).toString().replace(/\./g, ',')).digits()
                $("#sumResiduo").html(sumResiduo.toFixed(2).toString().replace(/\./g, ',')).digits()
                } else if(val.avviso.includes("1.4.1")){
                  sumSpesaPres += (val.importo_finanziamento * 20)/100
                    sumResiduo += val.importo_finanziamento - ((val.importo_finanziamento * 20)/100)
                  $("#sumSpesaPres").html(sumSpesaPres.toFixed(2).toString().replace(/\./g, ',')).digits()
                  $("#sumResiduo").html(sumResiduo.toFixed(2).toString().replace(/\./g, ',')).digits()
                } else if(val.avviso.includes("1.4.3 - app IO")){
                  sumSpesaPres += (val.importo_finanziamento * 40)/100
                    sumResiduo += val.importo_finanziamento - ((val.importo_finanziamento * 40)/100)
                  $("#sumSpesaPres").html(sumSpesaPres.toFixed(2).toString().replace(/\./g, ',')).digits()
                  $("#sumResiduo").html(sumResiduo.toFixed(2).toString().replace(/\./g, ',')).digits()
                } else if(val.avviso.includes("1.4.3 - pagoPA")){
                  sumSpesaPres += (val.importo_finanziamento * 35)/100
                    sumResiduo += val.importo_finanziamento - ((val.importo_finanziamento * 35)/100)
                  $("#sumSpesaPres").html(sumSpesaPres.toFixed(2).toString().replace(/\./g, ',')).digits()
                  $("#sumResiduo").html(sumResiduo.toFixed(2).toString().replace(/\./g, ',')).digits()
                } else if(val.avviso.includes("1.4.4")){
                  sumSpesaPres += (val.importo_finanziamento * 15)/100
                    sumResiduo += val.importo_finanziamento - ((val.importo_finanziamento * 15)/100)
                  $("#sumSpesaPres").html(sumSpesaPres.toFixed(2).toString().replace(/\./g, ',')).digits()
                  $("#sumResiduo").html(sumResiduo.toFixed(2).toString().replace(/\./g, ',')).digits()
                } else if(val.avviso.includes("1.4.5")){
                  sumSpesaPres += (val.importo_finanziamento * 60)/100
                    sumResiduo += val.importo_finanziamento - ((val.importo_finanziamento * 60)/100)
                  $("#sumSpesaPres").html(sumSpesaPres.toFixed(2).toString().replace(/\./g, ',')).digits()
                  $("#sumResiduo").html(sumResiduo.toFixed(2).toString().replace(/\./g, ',')).digits()
                }
              }
          });
          var outputArr = [];
          $.each(items, function(key, val) {
              outputArr.push([key, val]);
          });
          outputArr.sort();
          let sumImporto = 0
          let entrCorrenti = 0
          let entrCapitali = 0
          for(let i = 0; i < outputArr.length; i++)
          {
              if(outputArr[i][0].includes("1.2") || outputArr[i][0].includes("1.4.1") || outputArr[i][0].includes("1.4.3") || outputArr[i][0].includes("1.4.4") || outputArr[i][0].includes("1.4.5")){
                let newRow = $("<tr>")
                $("<td>").html("Comune di " + inputValue.toLowerCase().replace(/\b[a-z]/g, function(letter) {
                    return letter.toUpperCase();
                })).appendTo(newRow)
                $("<td>").html(outputArr[i][0]).appendTo(newRow)
                if(outputArr[i][0].includes("1.2")){
                  $("<td style='text-align: right'>").html((outputArr[i][1] - (outputArr[i][1]*15)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  entrCorrenti += outputArr[i][1] - (outputArr[i][1]*15)/100
                }else if(outputArr[i][0].includes("1.4.1")){
                  $("<td style='text-align: right'>").html((outputArr[i][1] - (outputArr[i][1]*20)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  entrCapitali += outputArr[i][1] - (outputArr[i][1]*20)/100
                }else if(outputArr[i][0].includes("1.4.3 - app IO")){
                  $("<td style='text-align: right'>").html((outputArr[i][1] - (outputArr[i][1]*40)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  entrCapitali += outputArr[i][1] - (outputArr[i][1]*40)/100
                }else if(outputArr[i][0].includes("1.4.3 - pagoPA")){
                  $("<td style='text-align: right'>").html((outputArr[i][1] - (outputArr[i][1]*35)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  entrCapitali += outputArr[i][1] - (outputArr[i][1]*35)/100
                }else if(outputArr[i][0].includes("1.4.4")){
                  $("<td style='text-align: right'>").html((outputArr[i][1] - (outputArr[i][1]*15)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                    entrCapitali += outputArr[i][1] - (outputArr[i][1]*15)/100
                }else if(outputArr[i][0].includes("1.4.5")){
                  $("<td style='text-align: right'>").html((outputArr[i][1] - (outputArr[i][1]*60)/100).toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                  entrCapitali += outputArr[i][1] - (outputArr[i][1]*60)/100
                }
                $("<td style='text-align: right'>").html(outputArr[i][1].toFixed(2).toString().replace(/\./g, ',')).digits().appendTo(newRow)
                sumImporto += outputArr[i][1]
                newRow.appendTo("#tableImporto tbody")
              }
          }
          $("#sumImporto").html(sumImporto.toFixed(2).toString().replace(/\./g, ',')).digits()
          $("#entrCorrenti").html(entrCorrenti.toFixed(2).toString().replace(/\./g, ',')).digits()
          $("#entrCapitali").html(entrCapitali.toFixed(2).toString().replace(/\./g, ',')).digits()
        });
      } 
      else {
        alert("Inserire un ente di cui calcolare l'importo!")
      }
  });
    </script>
</body>
</html>